// –í–µ—Ä—Å–∏—è –∫—ç—à–∞
const CACHE_NAME = 'achievements-v1';
const urlsToCache = [
  '/',
  '/index.html',
  '/manifest.json',
  '/icon-192.png',
  '/icon-512.png',
  '/sw.js'
];

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
self.addEventListener('install', event => {
  console.log('üì¶ Service Worker: –£—Å—Ç–∞–Ω–æ–≤–∫–∞...');
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => {
        console.log('üíæ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...');
        return cache.addAll(urlsToCache);
      })
  );
});

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è (–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫—ç—à–µ–π)
self.addEventListener('activate', event => {
  console.log('‚úÖ Service Worker: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName !== CACHE_NAME) {
            console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});

// –ü–µ—Ä–µ—Ö–≤–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º)
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (response) {
          console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫—ç—à–∞:', event.request.url);
          return response;
        }
        // –ò–Ω–∞—á–µ ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        return fetch(event.request)
          .then(response => {
            // –ö—ç—à–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
            if (response && response.status === 200) {
              const responseClone = response.clone();
              caches.open(CACHE_NAME).then(cache => {
                cache.put(event.request, responseClone);
              });
            }
            return response;
          })
          .catch(() => {
            // –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ –Ω–µ—Ç –≤ –∫—ç—à–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (event.request.url.includes('.html')) {
              return caches.match('/index.html');
            }
          });
      })
  );
});

// Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
self.addEventListener('push', event => {
  const title = 'üèÜ –ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!';
  const options = {
    body: event.data ? event.data.text() : '–í—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!',
    icon: '/icon-192.png',
    badge: '/icon-192.png',
    vibrate: [100, 50, 100],
    data: {
      dateOfArrival: Date.now(),
      primaryKey: 1
    }
  };
  event.waitUntil(self.registration.showNotification(title, options));
});